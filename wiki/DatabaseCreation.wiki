#summary Creating a chemical database

= Introduction =

In this example I show how to load a database from a pre-processed block of compounds from ChemBL.


= Preprocessing the input =

It's important to make sure all the molecules can be processed by the RDKit:
{{{
from rdkit import Chem

inf = file('chembl.extract.txt','r')
ok = file('chembl.proc.txt','w+')
fail = file('chembl.fail.txt','w+')

for i,l in enumerate(inf.readlines()):
     if i==0:
          ok.write(l)
          fail.write(l)
     else:
          smi = l.split('\t')[0].replace('=N#N','=[N+]=[N-]').replace('N#N=','[N-]=[N+]=')
          if len(smi)>300: continue    # <- this test makes sure we don't load anything huge.
          m = Chem.MolFromSmiles(smi)
          if not m:
               fail.write(l)
          else:
               ok.write(l)
     if not i%1000: 
        print "done: %d"%i
        ok.flush()
        fail.flush()
}}}

Get the set of unique molecules and the data table:
{{{
inf = file('chembl.proc.txt','r')
outf = file('chembl.reg.txt','w+')
dataf = file('chembl.data.txt','w+')

seen=set()

for i,l in enumerate(inf.readlines()):
     if i==0:
         continue
     else:
         l = l.split('\t')
         smi,regno = l[:2]
         if regno not in seen:
             smi = smi.replace('=N#N','=[N+]=[N-]').replace('N#N=','[N-]=[N+]=')
             outf.write('%s\t%s\n'%(regno,smi))
             seen.add(regno)
         dataf.write('\t'.join(l[1:]))
}}}

Then, from the shell, make sure backslashes are quoted:

{{{
~/RDKit/Data/Chembl > sed 's|\\|\\\\|g' chembl.reg.txt > chembl.reg.q.txt
~/RDKit/Data/Chembl > sed 's|\\|\\\\|g' chembl.data.txt > chembl.data.q.txt
}}}

= Creating the database =

{{{
~/RDKit/Data/Chembl > createdb chembl
~/RDKit/Data/Chembl > psql chembl < /usr/local/pgsql/share/contrib/rdkit.sql
}}}

= Loading the molecules =

{{{
~/RDKit/Data/Chembl > psql chembl
psql (8.4.1)
Type "help" for help.

chembl=# create table mols (regno integer primary key,m mol);
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "mols_pkey" for table "mols"
CREATE TABLE
chembl=# copy mols from '/home/glandrum/RDKit/Data/Chembl/chembl.reg.q.txt' delimiter E'\t';
chembl=# create index molidx on mols using gist(m);
}}}

This last step can be quite slow.