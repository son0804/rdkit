#summary Creating a chemical database
#labels cartridge,Tutorial

*_work in progress_*

= Introduction =

In this example I show how to load a database from a pre-processed block of compounds from ChemBL.

Once you've built the database, samples of how to query it can be found on the ExampleSimilarityQueries and ExampleStructureQueries pages.

= Preprocessing the input =

It's important to make sure all the molecules can be processed by the RDKit:
{{{
from rdkit import Chem

inf = file('chembl.extract.txt','r')
ok = file('chembl.proc.txt','w+')
fail = file('chembl.fail.txt','w+')

for i,l in enumerate(inf.readlines()):
     if i==0:
          ok.write(l)
          fail.write(l)
     else:
          smi = l.split('\t')[0].replace('=N#N','=[N+]=[N-]').replace('N#N=','[N-]=[N+]=')
          if len(smi)>300: continue    # <- this test makes sure we don't load anything huge.
          m = Chem.MolFromSmiles(smi)
          if not m:
               fail.write(l)
          else:
               ok.write(l)
     if not i%1000: 
        print "done: %d"%i
        ok.flush()
        fail.flush()
}}}

Get the set of unique molecules and the data table:
{{{
inf = file('chembl.proc.txt','r')
outf = file('chembl.reg.txt','w+')
dataf = file('chembl.data.txt','w+')

seen=set()

for i,l in enumerate(inf.readlines()):
     if i==0:
         continue
     else:
         l = l.split('\t')
         smi,regno = l[:2]
         if regno not in seen:
             smi = smi.replace('=N#N','=[N+]=[N-]').replace('N#N=','[N-]=[N+]=')
             outf.write('%s\t%s\n'%(regno,smi))
             seen.add(regno)
         dataf.write('\t'.join(l[1:]))
}}}

Then, from the shell, make sure backslashes are quoted:

{{{
~/RDKit/Data/Chembl > sed 's|\\|\\\\|g' chembl.reg.txt > chembl.reg.q.txt
~/RDKit/Data/Chembl > sed 's|\\|\\\\|g' chembl.data.txt > chembl.data.q.txt
}}}

= Creating the database =

{{{
~/RDKit/Data/Chembl > createdb chembl
~/RDKit/Data/Chembl > psql chembl < /usr/share/postgresql/8.4/contrib/rdkit.sql
}}}
Note that the path in the second command will depend on where postgresql is installed.

= Loading the molecules =

{{{
~/RDKit/Data/Chembl > psql chembl
psql (8.4.1)
Type "help" for help.

chembl=# create table mols (regno integer primary key,m mol);
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "mols_pkey" for table "mols"
CREATE TABLE
chembl=# copy mols from '/home/glandrum/RDKit/Data/Chembl/chembl.reg.q.txt' delimiter E'\t';
chembl=# create index molidx on mols using gist(m);
}}}

This last step can take a long time and is only required if you plan to do substructure searches.

Once the molecules are loaded you can take a look at them:

{{{
chembl=# select regno,m from mols limit 10;
 regno  |                                      m                                      
--------+-----------------------------------------------------------------------------
 358139 | N#Cc1cccc(-c2ccc3c(c2)CCN(CC(=O)Nc2cc(Cl)cc(Cl)c2)C32CCN(CC3CC3)CC2)c1
 358280 | N#Cc1cccc(-c2ccc3c(c2)CCN(CC(=O)Nc2cc(Cl)cc(Cl)c2)C3C2CCN(Cc3ccccc3)CC2)c1
 358600 | N#Cc1ccc(-c2ccc3c(c2)CCN(CC(=O)Nc2cc(Cl)cc(Cl)c2)C3C2CCN(C3CCCC3)CC2)cc1
 358268 | O=Cc1cccc(-c2ccc3c(c2)CCN(CC(=O)Nc2cc(Cl)cc(Cl)c2)C3C2CCN(C3CCCC3)CC2)c1
 358597 | N#Cc1cccc(-c2ccc3c(c2)CCN(CC(=O)Nc2ccc(F)c(C(F)(F)F)c2)C32CCN(CC3CC3)CC2)c1
 358396 | N#Cc1cccc(-c2ccc3c(c2)CCN(CC(=O)Nc2cc(Cl)cc(Cl)c2)C32CCN(C3CCSC3)CC2)c1
 359520 | N#Cc1cccc(-c2ccc3c(c2)CCN(Cc2nc4cc(Cl)c(Cl)cc4[nH]2)C3C2CCN(CC3CC3)CC2)c1
 358757 | N#Cc1cccc(-c2ccc3c(c2)CCN(CC(=O)Nc2ccc(Cl)c(Cl)c2)C32CCN(CC3CC3)CC2)c1
 358281 | N#Cc1cccc(-c2ccc3c(c2)CCN(CC(=O)Nc2cc(Cl)cc(Cl)c2)C3C2CCN(CCCCCO)CC2)c1
 374616 | CCCCNC(C1N(C(C(N)C(C)C)=O)CCC1)=O
(10 rows)
}}}

= Creating some fingerprints and the fingerprint indices =

{{{
chembl=# select regno,atompairbv_fp(m) as pairbv,torsionbv_fp(m) as torsionbv,morganbv_fp(m,2) as morganbv into fps from mols;
chembl=# create index apbvidx on fps using gist(pairbv);
chembl=# create index torsbvidx on fps using gist(torsionbv);
chembl=# create index morganbvidx on fps using gist(morganbv);
}}}


= Adding properties to the database =
{{{
chembl=# select regno,mol_amw(m) as amw,mol_logp(m) as logp,mol_hba(m) as hba,mol_hbd(m) as hbd,mol_numheavyatoms(m) as nhvy into props from mols;
}}}

----
[http://www.postgresql.org http://www.postgresql.org/files/community/propaganda/95x51_4.gif]